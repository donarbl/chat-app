<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat App</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>ðŸ’¬ Chat App</h1>
    <input id="sender" placeholder="Your name">
    <input id="message" placeholder="Type message">
    <button id="send">Send</button>
    <div id="feedback"></div>
    <ul id="chat"></ul>
  </div>

  <script>
    const feedback = document.getElementById('feedback');
    const sender = document.getElementById('sender');
    const message = document.getElementById('message');
    const send = document.getElementById('send');
    const chat = document.getElementById('chat');

    async function fetchMessages() {
      const res = await fetch('http://localhost:3000/messages');
      const msgs = await res.json();
      chat.innerHTML = msgs.map(m =>
        `<li>
          <div class="message-content">
            <div><b>${m.sender}:</b> <span class="message-text">${m.text}</span></div>
            <i>${m.time ? new Date(m.time).toLocaleString() : ''}</i>
          </div>
          <button onclick="deleteMessage(${m.id})">Delete</button>
         </li>`
      ).join('');
    }

    fetchMessages();

    // Function to send message
    async function sendMessage() {
      const senderName = sender.value.trim();
      const messageText = message.value.trim();

      // Check for empty fields
      if (!senderName || !messageText) {
        feedback.textContent = "Please enter both your name and message";
        feedback.style.color = "red";
        return;
      }

      try {
        const response = await fetch('http://localhost:3000/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sender: senderName, text: messageText })
        });

        if (!response.ok) {
          const result = await response.json();
          feedback.textContent = result.error || "Error sending message";
          feedback.style.color = "red";
        } else {
          feedback.textContent = "Message sent!";
          feedback.style.color = "green";
          sender.value = ""; // Clear inputs
          message.value = "";
          fetchMessages();
        }
      } catch (error) {
        feedback.textContent = "Network error. Server may be down";
        feedback.style.color = "red";
      }
    }

    // Send on button click
    send.onclick = sendMessage;

    // Send on Enter key press in sender field
    sender.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    // Send on Enter key press in message field
    message.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    // Delete message function
    async function deleteMessage(id) {
      try {
        const response = await fetch('http://localhost:3000/messages/' + id, {
          method: 'DELETE'
        });
        if (response.status === 204) {
          feedback.textContent = "Message deleted!";
          feedback.style.color = "green";
          fetchMessages();
        } else {
          const result = await response.json();
          feedback.textContent = result.error || "Error deleting message";
          feedback.style.color = "red";
        }
      } catch (error) {
        feedback.textContent = "Network error. Could not delete message";
        feedback.style.color = "red";
      }
    }
  </script>
</body>
</html>
