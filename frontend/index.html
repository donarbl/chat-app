<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat App - Real-time with Reactions</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .reactions {
      display: flex;
      gap: 8px;
      margin-left: 10px;
    }
    
    .reaction-btn {
      background: white;
      border: 2px solid #e0e0e0;
      padding: 4px 10px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .reaction-btn:hover {
      transform: scale(1.1);
    }
    
    .like-btn:hover {
      background: #d4edda;
      border-color: #28a745;
    }
    
    .dislike-btn:hover {
      background: #f8d7da;
      border-color: #dc3545;
    }
    
    .reaction-count {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>💬 Chat App (Real-time with Reactions)</h1>
    <div id="connection-status" style="text-align: center; margin-bottom: 10px; font-weight: bold; padding: 8px; border-radius: 5px;">
      Connecting...
    </div>
    <input id="sender" placeholder="Your name">
    <input id="message" placeholder="Type message">
    <button id="send">Send</button>
    <div id="feedback"></div>
    <ul id="chat"></ul>
  </div>

  <script>
    // ===== GLOBAL VARIABLES =====
    const feedback = document.getElementById('feedback');
    const sender = document.getElementById('sender');
    const message = document.getElementById('message');
    const send = document.getElementById('send');
    const chat = document.getElementById('chat');
    const connectionStatus = document.getElementById('connection-status');

    let ws;
    let messagesData = [];

    // ===== WEBSOCKET CONNECTION =====
    function connectWebSocket() {
     ws = new WebSocket('wss://cc08wwc0kc8ckoggws0g4ss.hosting.codeyourfuture.io');


      ws.onopen = () => {
        console.log('🟢 Connected to WebSocket server');
        connectionStatus.textContent = '🟢 Connected - Real-time updates enabled!';
        connectionStatus.style.backgroundColor = '#d4edda';
        connectionStatus.style.color = '#155724';
        connectionStatus.style.border = '1px solid #c3e6cb';
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log('📨 Received:', data);
        
        if (data.type === 'allMessages') {
          messagesData = data.messages;
          console.log('📋 Loaded messages:', messagesData);
          renderMessages();
        } else if (data.type === 'newMessage') {
          messagesData.push(data.message);
          renderMessages();
        } else if (data.type === 'deleteMessage') {
          messagesData = messagesData.filter(m => m.id !== data.messageId);
          renderMessages();
        } else if (data.type === 'likeMessage') {
          console.log('👍 Like update for message', data.messageId);
          const msg = messagesData.find(m => m.id === data.messageId);
          if (msg) {
            msg.likes = data.likes;
            console.log('👍 Updated to:', msg.likes);
            renderMessages();
          }
        } else if (data.type === 'dislikeMessage') {
          console.log('👎 Dislike update for message', data.messageId);
          const msg = messagesData.find(m => m.id === data.messageId);
          if (msg) {
            msg.dislikes = data.dislikes;
            console.log('👎 Updated to:', msg.dislikes);
            renderMessages();
          }
        }
      };

      ws.onerror = (error) => {
        console.error('🔴 WebSocket error:', error);
        connectionStatus.textContent = '🔴 Connection Error';
        connectionStatus.style.backgroundColor = '#f8d7da';
        connectionStatus.style.color = '#721c24';
      };

      ws.onclose = () => {
        console.log('🔴 Disconnected');
        connectionStatus.textContent = '🟡 Reconnecting...';
        connectionStatus.style.backgroundColor = '#fff3cd';
        connectionStatus.style.color = '#856404';
        setTimeout(connectWebSocket, 3000);
      };
    }

    connectWebSocket();

    // ===== RENDER MESSAGES =====
    function renderMessages() {
      console.log('🔄 Rendering', messagesData.length, 'messages');
      chat.innerHTML = messagesData.map(m => {
        console.log(`Message ${m.id}: likes=${m.likes}, dislikes=${m.dislikes}`);
        return `<li>
          <div class="message-content">
            <div><b>${m.sender}:</b> <span class="message-text">${m.text}</span></div>
            <i>${m.time ? new Date(m.time).toLocaleString() : ''}</i>
          </div>
          <div class="reactions">
            <button class="reaction-btn like-btn" onclick="window.likeMessage(${m.id})">
              👍 <span class="reaction-count">${m.likes || 0}</span>
            </button>
            <button class="reaction-btn dislike-btn" onclick="window.dislikeMessage(${m.id})">
              👎 <span class="reaction-count">${m.dislikes || 0}</span>
            </button>
            <button onclick="window.deleteMessage(${m.id})">Delete</button>
          </div>
         </li>`;
      }).join('');
    }

    // ===== SEND MESSAGE =====
    async function sendMessage() {
      const senderName = sender.value.trim();
      const messageText = message.value.trim();

      if (!senderName || !messageText) {
        feedback.textContent = "Please enter both your name and message";
        feedback.style.color = "red";
        return;
      }

      try {
        const response = await fetch('https://cc08wwc0kc8ckoggws0g4ss.hosting.codeyourfuture.io/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sender: senderName, text: messageText })
        });

        if (!response.ok) {
          const result = await response.json();
          feedback.textContent = result.error || "Error sending message";
          feedback.style.color = "red";
        } else {
          feedback.textContent = "Message sent!";
          feedback.style.color = "green";
          sender.value = "";
          message.value = "";
        }
      } catch (error) {
        feedback.textContent = "Network error";
        feedback.style.color = "red";
      }
    }

    // 👍 LIKE MESSAGE
    async function likeMessage(id) {
      console.log('👍 Liking message:', id);
      try {
        const response = await fetch(`https://cc08wwc0kc8ckoggws0g4ss.hosting.codeyourfuture.io/messages/${id}/like`, {
          method: 'POST'
        });
        console.log('👍 Response status:', response.status);
      } catch (error) {
        console.error('❌ Error liking:', error);
      }
    }

    // 👎 DISLIKE MESSAGE
    async function dislikeMessage(id) {
      console.log('👎 Disliking message:', id);
      try {
        const response = await fetch(`https://cc08wwc0kc8ckoggws0g4ss.hosting.codeyourfuture.io/messages/${id}/dislike`, {
          method: 'POST'
        });
        console.log('👎 Response status:', response.status);
      } catch (error) {
        console.error('❌ Error disliking:', error);
      }
    }

    // ===== DELETE MESSAGE =====
    async function deleteMessage(id) {
      try {
        const response = await fetch(`https://cc08wwc0kc8ckoggws0g4ss.hosting.codeyourfuture.io/messages/${id}`, {
          method: 'DELETE'
        });
        if (response.status === 204) {
          feedback.textContent = "Message deleted!";
          feedback.style.color = "green";
        }
      } catch (error) {
        feedback.textContent = "Error deleting message";
        feedback.style.color = "red";
      }
    }

    // ===== EVENT LISTENERS =====
    send.onclick = sendMessage;
    sender.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });
    message.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

    // ===== EXPOSE FUNCTIONS GLOBALLY =====
    window.likeMessage = likeMessage;
    window.dislikeMessage = dislikeMessage;
    window.deleteMessage = deleteMessage;
  </script>
</body>
</html>
